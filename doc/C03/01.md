# テーブルにユーザ情報を記録する 01

auth_user テーブルに、Wicketから入力した ユーザー名, パスワードを記録する。

以前、画面に表示するデータの生成を Spring で行ったように、入力値のデータベースへの記録は Spring に担当させる。

## データベースに接続するための設定を行う

Springのプログラム上から、データベースに接続するための設定を src > main > resources フォルダの  application.properties ファイルに追記する。

```properties
## これまでの記述内容を中略

### Springの設定
## JDBCの設定
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.url=jdbc:h2:file:~/h2db/wsbp_prac;MODE=PostgreSQL
spring.datasource.username=先ほど設定したデータベースのユーザー名
spring.datasource.password=先ほど設定したデータベースのパスワード
```

## Spring からデータベースを利用する

データベースなどの、アプリケーション外のデータ元（データ・ソース）を使うときに、Springでは Repository というクラスを作成する。

また、 Spring では様々なデータベース利用機能が提供されているが、ここでは最も基本的な Spring JDBC を利用する。

### パッケージの準備

`com.example.wsbp.repository` パッケージを作成する。以下はこのパッケージで作業する。

### Repositoryのインターフェースと実装クラスを作成する

#### IAuthUserRepository インターフェース

`com.example.wsbp.repository` パッケージに、   IAuthUserRepository インターフェースを作成する。

```java
package com.example.wsbp.repository;

public interface IAuthUserRepository {

   /**
   * ユーザー名とパスワードをAuthUserテーブルに記録する
   *
   * @param userName ユーザー名
   * @param userPass パスワード
   * @return データベースの更新行数
   */
  public int insert(String userName, String userPass);

}
```

#### AuthUserRepository クラス

IAuthUserRepository の実装クラスとして、AuthUserRepository を作成する。この実装クラスはSpringの中で Repository 用のクラスとして管理し、Spring JDBCを利用するように設定する。

```java
package com.example.wsbp.repository;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;

@Repository
public class AuthUserRepository implements IAuthUserRepository {

  // SpringJDBCのデータベース制御用インスタンス
  private final JdbcTemplate jdbc;

  // jdbc の di/ioc 設定（Wicketとやり方が異なるので注意）
  @Autowired
  public AuthUserRepository(JdbcTemplate jdbc) {
    this.jdbc = jdbc;
  }

  @Override
  public int insert(String userName, String userPass) {
    String sql = "insert into auth_user values (?, ?)";
    int n = jdbc.update(sql, userName, userPass);
    return n;
  }

}
```

- JDBCTemplate は、Spring JDBC が用意するデータベース制御用の型。データベースを操作する様々な機能がメソッドとして提供される。
- `@Autowiread` がついたコンストラクタは、 `jdbc` をIoC/DIする。WicketのWebPageにSpringのインスタンスを IoC/DI するときと、今回のように Spring から Spring のインスタンスをIoC/DIするときで、書き方が変わるので注意すること。
- sql は、先ほど作成した auth_user テーブルに ? と ? の2つのデータを入れることを指示するコマンド。
- `jdbc.update...` で、sql を実行するときに、最初の ? を userName 引数の値に、次の ? を userPass 引数の値に置換して実行している。

### Repository を呼びだす Service を作成する

`com.example.wsbp.service` パッケージに、  Repository を呼び出す 新しい Service を準備する。パッケージの切替に注意！

#### IUserService インターフェース

ユーザに関する機能を提供する IUserService インターフェースを作成する。

```java
package com.example.wsbp.service;

public interface IUserService {

  public void registerUser(String userName, String userPass);

}
```

#### UserService クラス

IUserService の実装クラスとして、UserRepository を作成する。この実装クラスは、Repository をIoC/DIして、データベースを使いながら、ユーザに関わる機能（サービス）をWicketに提供する。

```java
package com.example.wsbp.service;

import com.example.wsbp.repository.IAuthUserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class UserService implements IUserService {

  private IAuthUserRepository authUserRepos;

  @Autowired
  public UserService(IAuthUserRepository authUserRepos) {
    this.authUserRepos = authUserRepos;
  }

  @Override
  public void registerUser(String userName, String userPass) {
    int n = authUserRepos.insert(userName, userPass);
    System.out.println("記録行数：" + n);
  }

}
```

- `@Autowiread` がついたコンストラクタは、 `authUserRepos` をIoC/DIする。先ほどと同じように、 Spring から Spring のインスタンスをIoC/DIするときの書き方。
- この実装クラスはたいした働きをしていないように思えるが、**データベースにアクセスするRepository** と、**データベースのアクセスを使って何かの機能を提供するService** として、別々の役割を割り当てている。
    - Repository は、決まったテーブルにしかアクセスさせない。
    - Service は、いろんなRepositoryを使って、Wicketに機能を提供する
- こういった考え方は、 ファサードパターン という設計手法にも繋がっていくので、興味がある学生は勉強してみるとよい。

## WicketとSpringをつなげる




----

[目次へ](../../README.md) 